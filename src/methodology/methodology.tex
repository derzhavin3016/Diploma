В данной главе приводится описание предлагаемого решения. Сначала описывается непосредственно алгоритм подбора параметров микроархитектуры процессора, логика его работы. Далее приводится обзор среды моделирования, на которой производились запуски алгоритма подбора. В конце главы рассматривается инфраструктура, позволяющая упростить работу среды моделирования со статистикой.
\section{Описание алгоритма подбора}

Предлагаемый алгоритм подбора оптимальной конфигурации основан на отображении набора статистических данных, получаемых в результате симуляции, на параметры конфигурации процессора. В рассматриваемом алгоритме используются статистические данные, которые, как правило, появляются в больших промышленных и академических симуляторах производительности естественным образом в ходе работы над улучшениями микроархитектуры; либо несложным образом выражаются через стандартные статистические данные.

Каждому статистическому значению сопоставляется определённое множество параметров (непосредственно влияющих на данное статистическое значение) процессора, которым, в свою очередь, сопоставляются наборы возможных (варьируемых) значений. Упомянутые наборы определяют \textbf{пространство конфигураций}.

На каждой итерации алгоритма выполняются следующие действия:
% \begin{algorithm}
%   \caption{Описание алгоритма подбора}
%   \begin{algorithmic}
%     \State $предIPC \gets -1$
%     \Statex
%     \While{Есть доступные модификации}
%     \State $ЗапуститьСимулятор()$
%     \State $стаистика,\,IPC \gets СобратьСтатистику()$
%     \If{$предIPC \neq -1$}
%       \State $разница \gets IPC - предIPC$
%       \If{$разница < 0$}
%         \State $ОткатитьИзменение()$
%         \State $ИсключитьСтатистику из ()$
%       \EndIf
%     \EndIf
%     \EndWhile
%     \If{$i\geq 5$}
%     \State $i \gets i-1$
%     \Else
%     \If{$i\leq 3$}
%     \State $i \gets i+2$
%     \EndIf
%     \EndIf
%   \end{algorithmic}
% \end{algorithm}

\begin{enumerate}
  \item Запустить симулятор, собрать и усреднить статистические данные по трассам исполнения
  \item Вычислить  изменение IPC по сравнению с предыдущей итерацией
  \item Если изменение отрицательное, произвести откат последнего изменения параметра и исключить зависимую статистику из списка кандидатов до тех пор, пока переходом к другой точке пространства конфигураций не будет получено положительное изменение IPC (\picref{fig:rollback})
  \item Выбрать из списка кандидатов имеющее наибольшее относительное отклонение от порогового\footnote{Подбираются на основе предварительных инициализирующих запусков} статистическое значение
  \item Запросить изменение параметра конфигурации, от которого зависит выбранное статистическое значение
\end{enumerate}

\begin{figure}[!htbp]
  \centering
  \scalebox{1}{
  \begin{tikzpicture}
    \draw[step=1.5cm,gray,thin] (-1.5,-1.5) grid (3,3);
    \draw[black, thick] (0, 0) circle (4 pt);
    \draw[-Latex, ultra thick, midway, red] (0,0) -- node[right, black] {1} ++ (0,1.5);
    \draw[-Latex, ultra thick, dashed, midway] (-0.2,1.5) -- node[left] {2} ++ (0,-1.5);
    \draw[-Latex, ultra thick, midway, Green] (0,0) -- node[below, black] {3} ++ (1.5,0);
    \draw[thick,->, midway](-1.5,-1.5) -- node[below]{Параметр A} ++ (4.5,0);
    \draw[thick,->, midway](-1.5,-1.5) -- node[rotate=90,above]{Параметр B} ++ (0,4.5);
  \end{tikzpicture}
  }
  \caption{Принцип работы отката изменения}
  \label{fig:rollback}
\end{figure}

Описанный выше порядок действий повторяется до тех пор, пока не выполнится одно из условий:
\begin{itemize}
  \item Достижение требуемого улучшения производительности (если было задано)
  \item Исчерпание возможных направлений модификаций
  \item Превышение лимита числа итераций (если был задан)
\end{itemize}

\begin{figure}[!htbp]
  \centering
  \scalebox{0.862}{
    \input{src/methodology/algo}
  }
  \caption{Схема работы алгоритма}
\end{figure}



\section{Обзор среды моделирования}

Для тестирования предложенного алгоритма требовалось разработать среду моделирования, которая бы позволяла взаимодействовать с симулятором (например, для изменения параметров), а также производила сбор статистики полученной с трасс исполнения.

В силу большого разнообразия симуляторов, ориентированных под различные нужды, и как следствие значительных отличий в организации работы с ними, была поставлена задача сделать среду моделирования \textbf{симуляторонезависимой}~--- способной выступать в роли связующего звена между конкретным симулятором и алгоритмом, не вмешиваясь в работу последнего. Кроме того, из-за большого числа трасс исполнения в тестовых наборах приложений, было необходимо, чтобы среда моделирования поддерживала запуск нескольких трасс исполнения в параллельных потоках для уменьшения время работы алгоритма и лучшей утилизации вычислительных ресурсов кластерных систем, на которых и предполагается запуск реализованного алгоритма.

Схема работы реализованной среды моделирования представлена на \picref{fig:framework}.

Далее представлено описание элементов схемы.

\begin{itemize}
  \item \textbf{Обобщённый интерфейс} позволяет абстрагироваться от конкретного симулятора, обеспечивая взаимодействие с ним в обобщённом виде. Для добавления поддержки нового симулятора достаточно лишь описать ключевые моменты в работе с ним (процесс запуска, сбор статистики, изменение параметров), при этом не требуется вносить изменения в остальную (<<алгоритмическую>>) часть среды моделирования.
  \item \textbf{Алгоритм подбора} через обобщённый интерфейс получает от симулятора статистические данные запуска трасс исполнения. Далее происходит усреднение статистических данных, а также прироста IPC по трассам исполнения. Для того, чтобы получить осмысленное среднее значение прироста IPC, производится предварительная нормировка каждого значения IPC на значение на начальной итерации (под номером $0$) по формуле
  \[
    \text{IPC}_{ij}^{norm} = \dfrac{\text{IPC}_{ij}}{\text{IPC}_{0j}},
  \]
  где $i$~--- номер итерации, $j$~--- номер трассы исполнения. Тогда относительный прирост IPC на итерации $i$ для трассы $j$ может быть вычислен как
  \[
    \Delta \text{IPC}_{ij} = \text{IPC}_{ij}^{norm} - 1.
  \]
  В итоге среднее значение относительного прироста IPC вычисляется как
  \[
    \left\langle \Delta\text{IPC}_{i}\right\rangle =
    \sqrt[M]{\prod_{j = 1}^{M} \Delta \text{IPC}_{ij}}
  \]
  При этом среднее значение статистического значения  вычисляется по формуле
  \[
    \left\langle \text{Stat}_{i} \right\rangle =
    \dfrac{\displaystyle\sum_{j = 1}^{M} \text{Stat}_{ij}}{M},
  \]
  где $\text{Stat}_{ij}$ (по аналогии с IPC) есть статистическое значение с именем Stat, полученное с трассы исполнения с номером $j$ на $i$-ой итерации.

  На основании анализа статистики, через обобщённый интерфейс осуществляется запрос изменения выбранного зависимого параметра.
  \item \textbf{Кластер} (либо иная среда с возможностью параллельного исполнения) осуществляет параллельный запуск трасс исполнения на симуляторе.
\end{itemize}

\begin{figure}[ht!]
  \centering
  \scalebox{0.932}{
    \input{src/methodology/framework.tex}
  }
  \caption{Схема работы среды моделирования}
  \label{fig:framework}
\end{figure}

В среде моделирования реализована поддержка двух симуляторов производительности: gem5~\cite{binkert2011gem5} и ChampSim~\cite{gober2022championship}.

Для валидации работы алгоритма был добавлен режим полного перебора, в котором осуществляется проход по всем точкам конфигурационного пространства с запуском на них симулятора для нахождения максимально возможного IPC. По этой причине при выборе параметров для варьирования требовалось ограничиться небольшим числом параметров, чтобы алгоритм полного перебора успел просчитать все точки конфигурационного пространства за разумное время.

\section{Работа со статистикой в обобщённом виде}

В силу того, что формат хранения статистических данных сильно отличается от симулятора к симулятору (начиная с разных форматов файлов статистики и заканчивая различными названиями статистических данных и параметров), требовалось спроектировать инфраструктуру, которая бы обеспечила единообразный подход к анализу статистики с точки зрения алгоритма подбора.

\begin{listing}[!htbp]
  \centering
  \inputminted{js}{listings/mappings.json}
  \caption{Пример файла отображений}
  \label{lst:mappings}
\end{listing}

Каждый симулятор сопровождается файлом в формате JSON~\cite{bray2014javascript}, который называется \textbf{файлом отображений} (англ.~mappings file).


В листинге \ref{lst:mappings} представлен пример такого файла. В нём можно заметить две основные секции: определение множества варьируемых параметров с их отображением на статистические данные (по ключу \mintinline{js}{"statistics->parameters"}), а также соотнесение названий статистических данных симулятора с их обобщёнными аналогами (по ключу с именем \mintinline{js}{"statistics->generalized"}). Кроме того, в листинге \ref{lst:mappings} представлены все поддержанные варианты задания значений для параметров: строка, целое число, либо список целых чисел.

В ходе работы алгоритма, статистические значения (в обобщённом виде) сравниваются с пороговыми значениями, полученными в результате инициализирующих запусков симулятора. Они определены в \textbf{файле пороговых значений} (англ.~thresholds file) в формате JSON~\cite{bray2014javascript}. Пример такого файла представлен в листинге \ref{lst:thres}.

\begin{listing}[!ht]
  \centering
  \inputminted{js}{listings/thres.json}
  \caption{Пример файла пороговых значений}
  \label{lst:thres}
\end{listing}


Описанная выше инфраструктура позволяет алгоритму подбора оперировать исключительно обобщённой статистикой.
